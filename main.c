/**
  Generated main.c file from MPLAB Code Configurator

  @Company
    Microchip Technology Inc.

  @File Name
    main.c

  @Summary
    This is the generated main.c using PIC24 / dsPIC33 / PIC32MM MCUs.

  @Description
    This source file provides main entry point for system initialization and application code development.
    Generation Information :
        Product Revision  :  PIC24 / dsPIC33 / PIC32MM MCUs - 1.169.0
        Device            :  dsPIC33CK256MP202
    The generated drivers are tested against the following:
        Compiler          :  XC16 v1.50
        MPLAB 	          :  MPLAB X v5.40
*/

/*
    (c) 2020 Microchip Technology Inc. and its subsidiaries. You may use this
    software and any derivatives exclusively with Microchip products.

    THIS SOFTWARE IS SUPPLIED BY MICROCHIP "AS IS". NO WARRANTIES, WHETHER
    EXPRESS, IMPLIED OR STATUTORY, APPLY TO THIS SOFTWARE, INCLUDING ANY IMPLIED
    WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A
    PARTICULAR PURPOSE, OR ITS INTERACTION WITH MICROCHIP PRODUCTS, COMBINATION
    WITH ANY OTHER PRODUCTS, OR USE IN ANY APPLICATION.

    IN NO EVENT WILL MICROCHIP BE LIABLE FOR ANY INDIRECT, SPECIAL, PUNITIVE,
    INCIDENTAL OR CONSEQUENTIAL LOSS, DAMAGE, COST OR EXPENSE OF ANY KIND
    WHATSOEVER RELATED TO THE SOFTWARE, HOWEVER CAUSED, EVEN IF MICROCHIP HAS
    BEEN ADVISED OF THE POSSIBILITY OR THE DAMAGES ARE FORESEEABLE. TO THE
    FULLEST EXTENT ALLOWED BY LAW, MICROCHIP'S TOTAL LIABILITY ON ALL CLAIMS IN
    ANY WAY RELATED TO THIS SOFTWARE WILL NOT EXCEED THE AMOUNT OF FEES, IF ANY,
    THAT YOU HAVE PAID DIRECTLY TO MICROCHIP FOR THIS SOFTWARE.

    MICROCHIP PROVIDES THIS SOFTWARE CONDITIONALLY UPON YOUR ACCEPTANCE OF THESE
    TERMS.
*/

/**
  Section: Included Files
*/
#include "mcc_generated_files/system.h"
#include "mcc_generated_files/uart1.h"
#include "mcc_generated_files/pin_manager.h"
#include "mcc_generated_files/spi1.h"
#include "mcc_generated_files/adc1.h"
#include "mcc_generated_files/pwm.h"
#include "mcc_generated_files/tmr1.h"

#include <math.h>

/*
                         Main application
 */

#define PWM_FREQ 48000;

uint8_t state = 0;
#define STATE_IDLE 0x00
#define STATE_LOG 0x01
#define STATE_GEN 0x02
#define STATE_GL 0x03
#define STATE_SEND 0x04
#define STATE_TEST 0xFF

uint8_t dev_ID = 0xFF;
#define DEV_ID_Master 0x00;

uint16_t x = 0;
uint16_t y = 0;

uint8_t uart1 = 0;
uint8_t uart2 = 0;

uint16_t ramStat[8] = {0,0,0,0,0,0,0,0};
uint16_t flashStat[8] = {0,0,0,0,0,0,0,0};
uint16_t StatCmd[8] = {0x05,0,0,0,0,0,0,0};
uint16_t ana_read[6] = {0,0,0,0,0,0};
uint16_t ReadStat_CMD = 0x0005;
uint16_t temp = 0;

#define buffMax 0x780
uint16_t  __attribute__((space(ymemory), aligned(32))) buffer[2][buffMax];
uint16_t bufptr = 0;

#define SINROM_SIZE 0x1000
int16_t  __attribute__((space(auto_psv))) sinROM[SINROM_SIZE] = {32767,32767,32767,32767,32767,32767,32767,32767,32766,32766,32766,32766,32766,32765,32765,32765,32765,32764,32764,32764,32763,32763,32762,32762,32761,32761,32760,32760,32759,32759,32758,32758,32757,32756,32756,32755,32755,32754,32753,32752,32752,32751,32750,32749,32748,32747,32747,32746,32745,32744,32743,32742,32741,32740,32739,32738,32737,32736,32735,32733,32732,32731,32730,32729,32728,32726,32725,32724,32722,32721,32720,32718,32717,32716,32714,32713,32711,32710,32708,32707,32705,32704,32702,32701,32699,32697,32696,32694,32692,32691,32689,32687,32685,32684,32682,32680,32678,32676,32674,32673,32671,32669,32667,32665,32663,32661,32659,32657,32655,32653,32650,32648,32646,32644,32642,32640,32637,32635,32633,32631,32628,32626,32624,32621,32619,32616,32614,32612,32609,32607,32604,32602,32599,32597,32594,32591,32589,32586,32584,32581,32578,32575,32573,32570,32567,32564,32562,32559,32556,32553,32550,32547,32544,32542,32539,32536,32533,32530,32527,32524,32520,32517,32514,32511,32508,32505,32502,32498,32495,32492,32489,32485,32482,32479,32475,32472,32469,32465,32462,32459,32455,32452,32448,32445,32441,32438,32434,32430,32427,32423,32420,32416,32412,32408,32405,32401,32397,32393,32390,32386,32382,32378,32374,32370,32367,32363,32359,32355,32351,32347,32343,32339,32335,32330,32326,32322,32318,32314,32310,32306,32301,32297,32293,32289,32284,32280,32276,32271,32267,32263,32258,32254,32249,32245,32240,32236,32231,32227,32222,32218,32213,32209,32204,32199,32195,32190,32185,32180,32176,32171,32166,32161,32157,32152,32147,32142,32137,32132,32127,32122,32117,32112,32107,32102,32097,32092,32087,32082,32077,32072,32067,32061,32056,32051,32046,32040,32035,32030,32025,32019,32014,32009,32003,31998,31992,31987,31981,31976,31970,31965,31959,31954,31948,31943,31937,31931,31926,31920,31914,31909,31903,31897,31891,31886,31880,31874,31868,31862,31856,31851,31845,31839,31833,31827,31821,31815,31809,31803,31797,31791,31785,31778,31772,31766,31760,31754,31748,31741,31735,31729,31722,31716,31710,31704,31697,31691,31684,31678,31672,31665,31659,31652,31646,31639,31633,31626,31619,31613,31606,31599,31593,31586,31579,31573,31566,31559,31552,31546,31539,31532,31525,31518,31511,31505,31498,31491,31484,31477,31470,31463,31456,31449,31442,31435,31427,31420,31413,31406,31399,31392,31384,31377,31370,31363,31355,31348,31341,31333,31326,31319,31311,31304,31296,31289,31281,31274,31266,31259,31251,31244,31236,31229,31221,31213,31206,31198,31190,31183,31175,31167,31159,31152,31144,31136,31128,31120,31112,31104,31097,31089,31081,31073,31065,31057,31049,31041,31033,31024,31016,31008,31000,30992,30984,30976,30967,30959,30951,30943,30934,30926,30918,30909,30901,30893,30884,30876,30868,30859,30851,30842,30834,30825,30817,30808,30799,30791,30782,30774,30765,30756,30748,30739,30730,30722,30713,30704,30695,30686,30678,30669,30660,30651,30642,30633,30624,30615,30606,30597,30588,30579,30570,30561,30552,30543,30534,30525,30516,30506,30497,30488,30479,30470,30460,30451,30442,30433,30423,30414,30404,30395,30386,30376,30367,30357,30348,30338,30329,30319,30310,30300,30291,30281,30272,30262,30252,30243,30233,30223,30213,30204,30194,30184,30174,30165,30155,30145,30135,30125,30115,30105,30095,30085,30076,30066,30056,30046,30035,30025,30015,30005,29995,29985,29975,29965,29955,29944,29934,29924,29914,29903,29893,29883,29872,29862,29852,29841,29831,29821,29810,29800,29789,29779,29768,29758,29747,29737,29726,29716,29705,29694,29684,29673,29662,29652,29641,29630,29619,29609,29598,29587,29576,29565,29555,29544,29533,29522,29511,29500,29489,29478,29467,29456,29445,29434,29423,29412,29401,29390,29379,29368,29356,29345,29334,29323,29312,29300,29289,29278,29267,29255,29244,29233,29221,29210,29198,29187,29176,29164,29153,29141,29130,29118,29107,29095,29083,29072,29060,29049,29037,29025,29014,29002,28990,28979,28967,28955,28943,28931,28920,28908,28896,28884,28872,28860,28848,28837,28825,28813,28801,28789,28777,28765,28753,28740,28728,28716,28704,28692,28680,28668,28656,28643,28631,28619,28607,28594,28582,28570,28557,28545,28533,28520,28508,28496,28483,28471,28458,28446,28433,28421,28408,28396,28383,28371,28358,28346,28333,28320,28308,28295,28282,28270,28257,28244,28231,28219,28206,28193,28180,28167,28154,28142,28129,28116,28103,28090,28077,28064,28051,28038,28025,28012,27999,27986,27973,27960,27947,27933,27920,27907,27894,27881,27868,27854,27841,27828,27815,27801,27788,27775,27761,27748,27734,27721,27708,27694,27681,27667,27654,27640,27627,27613,27600,27586,27573,27559,27545,27532,27518,27505,27491,27477,27464,27450,27436,27422,27409,27395,27381,27367,27353,27339,27326,27312,27298,27284,27270,27256,27242,27228,27214,27200,27186,27172,27158,27144,27130,27116,27102,27087,27073,27059,27045,27031,27017,27002,26988,26974,26959,26945,26931,26917,26902,26888,26873,26859,26845,26830,26816,26801,26787,26772,26758,26743,26729,26714,26700,26685,26671,26656,26641,26627,26612,26597,26583,26568,26553,26538,26524,26509,26494,26479,26465,26450,26435,26420,26405,26390,26375,26360,26345,26331,26316,26301,26286,26271,26256,26240,26225,26210,26195,26180,26165,26150,26135,26120,26104,26089,26074,26059,26043,26028,26013,25998,25982,25967,25952,25936,25921,25906,25890,25875,25859,25844,25828,25813,25797,25782,25766,25751,25735,25720,25704,25689,25673,25657,25642,25626,25610,25595,25579,25563,25547,25532,25516,25500,25484,25469,25453,25437,25421,25405,25389,25373,25358,25342,25326,25310,25294,25278,25262,25246,25230,25214,25198,25181,25165,25149,25133,25117,25101,25085,25069,25052,25036,25020,25004,24987,24971,24955,24939,24922,24906,24890,24873,24857,24840,24824,24808,24791,24775,24758,24742,24725,24709,24692,24676,24659,24643,24626,24609,24593,24576,24560,24543,24526,24510,24493,24476,24460,24443,24426,24409,24393,24376,24359,24342,24325,24308,24292,24275,24258,24241,24224,24207,24190,24173,24156,24139,24122,24105,24088,24071,24054,24037,24020,24003,23986,23968,23951,23934,23917,23900,23883,23865,23848,23831,23814,23796,23779,23762,23744,23727,23710,23692,23675,23658,23640,23623,23605,23588,23570,23553,23536,23518,23501,23483,23465,23448,23430,23413,23395,23378,23360,23342,23325,23307,23289,23272,23254,23236,23218,23201,23183,23165,23147,23130,23112,23094,23076,23058,23040,23023,23005,22987,22969,22951,22933,22915,22897,22879,22861,22843,22825,22807,22789,22771,22753,22735,22716,22698,22680,22662,22644,22626,22608,22589,22571,22553,22535,22516,22498,22480,22462,22443,22425,22407,22388,22370,22351,22333,22315,22296,22278,22259,22241,22222,22204,22186,22167,22148,22130,22111,22093,22074,22056,22037,22018,22000,21981,21963,21944,21925,21907,21888,21869,21850,21832,21813,21794,21775,21757,21738,21719,21700,21681,21662,21644,21625,21606,21587,21568,21549,21530,21511,21492,21473,21454,21435,21416,21397,21378,21359,21340,21321,21302,21283,21264,21244,21225,21206,21187,21168,21149,21129,21110,21091,21072,21052,21033,21014,20995,20975,20956,20937,20917,20898,20879,20859,20840,20820,20801,20782,20762,20743,20723,20704,20684,20665,20645,20626,20606,20587,20567,20547,20528,20508,20489,20469,20449,20430,20410,20390,20371,20351,20331,20312,20292,20272,20252,20233,20213,20193,20173,20153,20134,20114,20094,20074,20054,20034,20014,19994,19975,19955,19935,19915,19895,19875,19855,19835,19815,19795,19775,19755,19735,19714,19694,19674,19654,19634,19614,19594,19574,19553,19533,19513,19493,19473,19452,19432,19412,19392,19371,19351,19331,19311,19290,19270,19250,19229,19209,19189,19168,19148,19127,19107,19086,19066,19046,19025,19005,18984,18964,18943,18923,18902,18882,18861,18840,18820,18799,18779,18758,18737,18717,18696,18676,18655,18634,18614,18593,18572,18551,18531,18510,18489,18468,18448,18427,18406,18385,18365,18344,18323,18302,18281,18260,18239,18219,18198,18177,18156,18135,18114,18093,18072,18051,18030,18009,17988,17967,17946,17925,17904,17883,17862,17841,17820,17798,17777,17756,17735,17714,17693,17672,17650,17629,17608,17587,17566,17544,17523,17502,17481,17459,17438,17417,17396,17374,17353,17332,17310,17289,17268,17246,17225,17203,17182,17161,17139,17118,17096,17075,17053,17032,17010,16989,16967,16946,16924,16903,16881,16860,16838,16817,16795,16774,16752,16730,16709,16687,16665,16644,16622,16600,16579,16557,16535,16514,16492,16470,16449,16427,16405,16383,16361,16340,16318,16296,16274,16252,16231,16209,16187,16165,16143,16121,16099,16078,16056,16034,16012,15990,15968,15946,15924,15902,15880,15858,15836,15814,15792,15770,15748,15726,15704,15682,15660,15638,15615,15593,15571,15549,15527,15505,15483,15461,15438,15416,15394,15372,15350,15327,15305,15283,15261,15238,15216,15194,15172,15149,15127,15105,15082,15060,15038,15015,14993,14971,14948,14926,14904,14881,14859,14836,14814,14792,14769,14747,14724,14702,14679,14657,14634,14612,14589,14567,14544,14522,14499,14477,14454,14432,14409,14386,14364,14341,14319,14296,14273,14251,14228,14205,14183,14160,14137,14115,14092,14069,14047,14024,14001,13979,13956,13933,13910,13888,13865,13842,13819,13796,13774,13751,13728,13705,13682,13659,13637,13614,13591,13568,13545,13522,13499,13476,13453,13431,13408,13385,13362,13339,13316,13293,13270,13247,13224,13201,13178,13155,13132,13109,13086,13063,13040,13017,12993,12970,12947,12924,12901,12878,12855,12832,12809,12785,12762,12739,12716,12693,12670,12646,12623,12600,12577,12554,12530,12507,12484,12461,12437,12414,12391,12368,12344,12321,12298,12274,12251,12228,12204,12181,12158,12134,12111,12088,12064,12041,12018,11994,11971,11947,11924,11901,11877,11854,11830,11807,11783,11760,11736,11713,11689,11666,11643,11619,11596,11572,11548,11525,11501,11478,11454,11431,11407,11384,11360,11336,11313,11289,11266,11242,11218,11195,11171,11148,11124,11100,11077,11053,11029,11006,10982,10958,10935,10911,10887,10863,10840,10816,10792,10769,10745,10721,10697,10673,10650,10626,10602,10578,10555,10531,10507,10483,10459,10436,10412,10388,10364,10340,10316,10292,10269,10245,10221,10197,10173,10149,10125,10101,10077,10053,10030,10006,9982,9958,9934,9910,9886,9862,9838,9814,9790,9766,9742,9718,9694,9670,9646,9622,9598,9574,9550,9526,9502,9478,9454,9429,9405,9381,9357,9333,9309,9285,9261,9237,9213,9188,9164,9140,9116,9092,9068,9044,9019,8995,8971,8947,8923,8898,8874,8850,8826,8802,8777,8753,8729,8705,8681,8656,8632,8608,8584,8559,8535,8511,8486,8462,8438,8414,8389,8365,8341,8316,8292,8268,8243,8219,8195,8170,8146,8122,8097,8073,8049,8024,8000,7975,7951,7927,7902,7878,7853,7829,7805,7780,7756,7731,7707,7683,7658,7634,7609,7585,7560,7536,7511,7487,7462,7438,7413,7389,7364,7340,7315,7291,7266,7242,7217,7193,7168,7144,7119,7095,7070,7046,7021,6997,6972,6947,6923,6898,6874,6849,6825,6800,6775,6751,6726,6702,6677,6652,6628,6603,6578,6554,6529,6505,6480,6455,6431,6406,6381,6357,6332,6307,6283,6258,6233,6209,6184,6159,6135,6110,6085,6060,6036,6011,5986,5962,5937,5912,5887,5863,5838,5813,5789,5764,5739,5714,5690,5665,5640,5615,5590,5566,5541,5516,5491,5467,5442,5417,5392,5367,5343,5318,5293,5268,5243,5219,5194,5169,5144,5119,5094,5070,5045,5020,4995,4970,4945,4921,4896,4871,4846,4821,4796,4771,4746,4722,4697,4672,4647,4622,4597,4572,4547,4523,4498,4473,4448,4423,4398,4373,4348,4323,4298,4273,4248,4224,4199,4174,4149,4124,4099,4074,4049,4024,3999,3974,3949,3924,3899,3874,3849,3824,3799,3774,3749,3724,3700,3675,3650,3625,3600,3575,3550,3525,3500,3475,3450,3425,3400,3375,3350,3325,3300,3275,3250,3225,3200,3175,3150,3124,3099,3074,3049,3024,2999,2974,2949,2924,2899,2874,2849,2824,2799,2774,2749,2724,2699,2674,2649,2624,2599,2574,2548,2523,2498,2473,2448,2423,2398,2373,2348,2323,2298,2273,2248,2223,2197,2172,2147,2122,2097,2072,2047,2022,1997,1972,1947,1921,1896,1871,1846,1821,1796,1771,1746,1721,1696,1670,1645,1620,1595,1570,1545,1520,1495,1470,1444,1419,1394,1369,1344,1319,1294,1269,1244,1218,1193,1168,1143,1118,1093,1068,1043,1017,992,967,942,917,892,867,842,816,791,766,741,716,691,666,640,615,590,565,540,515,490,465,439,414,389,364,339,314,289,263,238,213,188,163,138,113,87,62,37,12,-13,-38,-63,-88,-114,-139,-164,-189,-214,-239,-264,-290,-315,-340,-365,-390,-415,-440,-466,-491,-516,-541,-566,-591,-616,-641,-667,-692,-717,-742,-767,-792,-817,-843,-868,-893,-918,-943,-968,-993,-1018,-1044,-1069,-1094,-1119,-1144,-1169,-1194,-1219,-1245,-1270,-1295,-1320,-1345,-1370,-1395,-1420,-1445,-1471,-1496,-1521,-1546,-1571,-1596,-1621,-1646,-1671,-1697,-1722,-1747,-1772,-1797,-1822,-1847,-1872,-1897,-1922,-1948,-1973,-1998,-2023,-2048,-2073,-2098,-2123,-2148,-2173,-2198,-2224,-2249,-2274,-2299,-2324,-2349,-2374,-2399,-2424,-2449,-2474,-2499,-2524,-2549,-2575,-2600,-2625,-2650,-2675,-2700,-2725,-2750,-2775,-2800,-2825,-2850,-2875,-2900,-2925,-2950,-2975,-3000,-3025,-3050,-3075,-3100,-3125,-3151,-3176,-3201,-3226,-3251,-3276,-3301,-3326,-3351,-3376,-3401,-3426,-3451,-3476,-3501,-3526,-3551,-3576,-3601,-3626,-3651,-3676,-3701,-3725,-3750,-3775,-3800,-3825,-3850,-3875,-3900,-3925,-3950,-3975,-4000,-4025,-4050,-4075,-4100,-4125,-4150,-4175,-4200,-4225,-4249,-4274,-4299,-4324,-4349,-4374,-4399,-4424,-4449,-4474,-4499,-4524,-4548,-4573,-4598,-4623,-4648,-4673,-4698,-4723,-4747,-4772,-4797,-4822,-4847,-4872,-4897,-4922,-4946,-4971,-4996,-5021,-5046,-5071,-5095,-5120,-5145,-5170,-5195,-5220,-5244,-5269,-5294,-5319,-5344,-5368,-5393,-5418,-5443,-5468,-5492,-5517,-5542,-5567,-5591,-5616,-5641,-5666,-5691,-5715,-5740,-5765,-5790,-5814,-5839,-5864,-5888,-5913,-5938,-5963,-5987,-6012,-6037,-6061,-6086,-6111,-6136,-6160,-6185,-6210,-6234,-6259,-6284,-6308,-6333,-6358,-6382,-6407,-6432,-6456,-6481,-6506,-6530,-6555,-6579,-6604,-6629,-6653,-6678,-6703,-6727,-6752,-6776,-6801,-6826,-6850,-6875,-6899,-6924,-6948,-6973,-6998,-7022,-7047,-7071,-7096,-7120,-7145,-7169,-7194,-7218,-7243,-7267,-7292,-7316,-7341,-7365,-7390,-7414,-7439,-7463,-7488,-7512,-7537,-7561,-7586,-7610,-7635,-7659,-7684,-7708,-7732,-7757,-7781,-7806,-7830,-7854,-7879,-7903,-7928,-7952,-7976,-8001,-8025,-8050,-8074,-8098,-8123,-8147,-8171,-8196,-8220,-8244,-8269,-8293,-8317,-8342,-8366,-8390,-8415,-8439,-8463,-8487,-8512,-8536,-8560,-8585,-8609,-8633,-8657,-8682,-8706,-8730,-8754,-8778,-8803,-8827,-8851,-8875,-8899,-8924,-8948,-8972,-8996,-9020,-9045,-9069,-9093,-9117,-9141,-9165,-9189,-9214,-9238,-9262,-9286,-9310,-9334,-9358,-9382,-9406,-9430,-9455,-9479,-9503,-9527,-9551,-9575,-9599,-9623,-9647,-9671,-9695,-9719,-9743,-9767,-9791,-9815,-9839,-9863,-9887,-9911,-9935,-9959,-9983,-10007,-10031,-10054,-10078,-10102,-10126,-10150,-10174,-10198,-10222,-10246,-10270,-10293,-10317,-10341,-10365,-10389,-10413,-10437,-10460,-10484,-10508,-10532,-10556,-10579,-10603,-10627,-10651,-10674,-10698,-10722,-10746,-10770,-10793,-10817,-10841,-10864,-10888,-10912,-10936,-10959,-10983,-11007,-11030,-11054,-11078,-11101,-11125,-11149,-11172,-11196,-11219,-11243,-11267,-11290,-11314,-11337,-11361,-11385,-11408,-11432,-11455,-11479,-11502,-11526,-11549,-11573,-11597,-11620,-11644,-11667,-11690,-11714,-11737,-11761,-11784,-11808,-11831,-11855,-11878,-11902,-11925,-11948,-11972,-11995,-12019,-12042,-12065,-12089,-12112,-12135,-12159,-12182,-12205,-12229,-12252,-12275,-12299,-12322,-12345,-12369,-12392,-12415,-12438,-12462,-12485,-12508,-12531,-12555,-12578,-12601,-12624,-12647,-12671,-12694,-12717,-12740,-12763,-12786,-12810,-12833,-12856,-12879,-12902,-12925,-12948,-12971,-12994,-13018,-13041,-13064,-13087,-13110,-13133,-13156,-13179,-13202,-13225,-13248,-13271,-13294,-13317,-13340,-13363,-13386,-13409,-13432,-13454,-13477,-13500,-13523,-13546,-13569,-13592,-13615,-13638,-13660,-13683,-13706,-13729,-13752,-13775,-13797,-13820,-13843,-13866,-13889,-13911,-13934,-13957,-13980,-14002,-14025,-14048,-14070,-14093,-14116,-14138,-14161,-14184,-14206,-14229,-14252,-14274,-14297,-14320,-14342,-14365,-14387,-14410,-14433,-14455,-14478,-14500,-14523,-14545,-14568,-14590,-14613,-14635,-14658,-14680,-14703,-14725,-14748,-14770,-14793,-14815,-14837,-14860,-14882,-14905,-14927,-14949,-14972,-14994,-15016,-15039,-15061,-15083,-15106,-15128,-15150,-15173,-15195,-15217,-15239,-15262,-15284,-15306,-15328,-15351,-15373,-15395,-15417,-15439,-15462,-15484,-15506,-15528,-15550,-15572,-15594,-15616,-15639,-15661,-15683,-15705,-15727,-15749,-15771,-15793,-15815,-15837,-15859,-15881,-15903,-15925,-15947,-15969,-15991,-16013,-16035,-16057,-16079,-16100,-16122,-16144,-16166,-16188,-16210,-16232,-16253,-16275,-16297,-16319,-16341,-16362,-16384,-16406,-16428,-16450,-16471,-16493,-16515,-16536,-16558,-16580,-16601,-16623,-16645,-16666,-16688,-16710,-16731,-16753,-16775,-16796,-16818,-16839,-16861,-16882,-16904,-16925,-16947,-16968,-16990,-17011,-17033,-17054,-17076,-17097,-17119,-17140,-17162,-17183,-17204,-17226,-17247,-17269,-17290,-17311,-17333,-17354,-17375,-17397,-17418,-17439,-17460,-17482,-17503,-17524,-17545,-17567,-17588,-17609,-17630,-17651,-17673,-17694,-17715,-17736,-17757,-17778,-17799,-17821,-17842,-17863,-17884,-17905,-17926,-17947,-17968,-17989,-18010,-18031,-18052,-18073,-18094,-18115,-18136,-18157,-18178,-18199,-18220,-18240,-18261,-18282,-18303,-18324,-18345,-18366,-18386,-18407,-18428,-18449,-18469,-18490,-18511,-18532,-18552,-18573,-18594,-18615,-18635,-18656,-18677,-18697,-18718,-18738,-18759,-18780,-18800,-18821,-18841,-18862,-18883,-18903,-18924,-18944,-18965,-18985,-19006,-19026,-19047,-19067,-19087,-19108,-19128,-19149,-19169,-19190,-19210,-19230,-19251,-19271,-19291,-19312,-19332,-19352,-19372,-19393,-19413,-19433,-19453,-19474,-19494,-19514,-19534,-19554,-19575,-19595,-19615,-19635,-19655,-19675,-19695,-19715,-19736,-19756,-19776,-19796,-19816,-19836,-19856,-19876,-19896,-19916,-19936,-19956,-19976,-19995,-20015,-20035,-20055,-20075,-20095,-20115,-20135,-20154,-20174,-20194,-20214,-20234,-20253,-20273,-20293,-20313,-20332,-20352,-20372,-20391,-20411,-20431,-20450,-20470,-20490,-20509,-20529,-20548,-20568,-20588,-20607,-20627,-20646,-20666,-20685,-20705,-20724,-20744,-20763,-20783,-20802,-20821,-20841,-20860,-20880,-20899,-20918,-20938,-20957,-20976,-20996,-21015,-21034,-21053,-21073,-21092,-21111,-21130,-21150,-21169,-21188,-21207,-21226,-21245,-21265,-21284,-21303,-21322,-21341,-21360,-21379,-21398,-21417,-21436,-21455,-21474,-21493,-21512,-21531,-21550,-21569,-21588,-21607,-21626,-21645,-21663,-21682,-21701,-21720,-21739,-21758,-21776,-21795,-21814,-21833,-21851,-21870,-21889,-21908,-21926,-21945,-21964,-21982,-22001,-22019,-22038,-22057,-22075,-22094,-22112,-22131,-22149,-22168,-22187,-22205,-22223,-22242,-22260,-22279,-22297,-22316,-22334,-22352,-22371,-22389,-22408,-22426,-22444,-22463,-22481,-22499,-22517,-22536,-22554,-22572,-22590,-22609,-22627,-22645,-22663,-22681,-22699,-22717,-22736,-22754,-22772,-22790,-22808,-22826,-22844,-22862,-22880,-22898,-22916,-22934,-22952,-22970,-22988,-23006,-23024,-23041,-23059,-23077,-23095,-23113,-23131,-23148,-23166,-23184,-23202,-23219,-23237,-23255,-23273,-23290,-23308,-23326,-23343,-23361,-23379,-23396,-23414,-23431,-23449,-23466,-23484,-23502,-23519,-23537,-23554,-23571,-23589,-23606,-23624,-23641,-23659,-23676,-23693,-23711,-23728,-23745,-23763,-23780,-23797,-23815,-23832,-23849,-23866,-23884,-23901,-23918,-23935,-23952,-23969,-23987,-24004,-24021,-24038,-24055,-24072,-24089,-24106,-24123,-24140,-24157,-24174,-24191,-24208,-24225,-24242,-24259,-24276,-24293,-24309,-24326,-24343,-24360,-24377,-24394,-24410,-24427,-24444,-24461,-24477,-24494,-24511,-24527,-24544,-24561,-24577,-24594,-24610,-24627,-24644,-24660,-24677,-24693,-24710,-24726,-24743,-24759,-24776,-24792,-24809,-24825,-24841,-24858,-24874,-24891,-24907,-24923,-24940,-24956,-24972,-24988,-25005,-25021,-25037,-25053,-25070,-25086,-25102,-25118,-25134,-25150,-25166,-25182,-25199,-25215,-25231,-25247,-25263,-25279,-25295,-25311,-25327,-25343,-25359,-25374,-25390,-25406,-25422,-25438,-25454,-25470,-25485,-25501,-25517,-25533,-25548,-25564,-25580,-25596,-25611,-25627,-25643,-25658,-25674,-25690,-25705,-25721,-25736,-25752,-25767,-25783,-25798,-25814,-25829,-25845,-25860,-25876,-25891,-25907,-25922,-25937,-25953,-25968,-25983,-25999,-26014,-26029,-26044,-26060,-26075,-26090,-26105,-26121,-26136,-26151,-26166,-26181,-26196,-26211,-26226,-26241,-26257,-26272,-26287,-26302,-26317,-26332,-26346,-26361,-26376,-26391,-26406,-26421,-26436,-26451,-26466,-26480,-26495,-26510,-26525,-26539,-26554,-26569,-26584,-26598,-26613,-26628,-26642,-26657,-26672,-26686,-26701,-26715,-26730,-26744,-26759,-26773,-26788,-26802,-26817,-26831,-26846,-26860,-26874,-26889,-26903,-26918,-26932,-26946,-26960,-26975,-26989,-27003,-27018,-27032,-27046,-27060,-27074,-27088,-27103,-27117,-27131,-27145,-27159,-27173,-27187,-27201,-27215,-27229,-27243,-27257,-27271,-27285,-27299,-27313,-27327,-27340,-27354,-27368,-27382,-27396,-27410,-27423,-27437,-27451,-27465,-27478,-27492,-27506,-27519,-27533,-27546,-27560,-27574,-27587,-27601,-27614,-27628,-27641,-27655,-27668,-27682,-27695,-27709,-27722,-27735,-27749,-27762,-27776,-27789,-27802,-27816,-27829,-27842,-27855,-27869,-27882,-27895,-27908,-27921,-27934,-27948,-27961,-27974,-27987,-28000,-28013,-28026,-28039,-28052,-28065,-28078,-28091,-28104,-28117,-28130,-28143,-28155,-28168,-28181,-28194,-28207,-28220,-28232,-28245,-28258,-28271,-28283,-28296,-28309,-28321,-28334,-28347,-28359,-28372,-28384,-28397,-28409,-28422,-28434,-28447,-28459,-28472,-28484,-28497,-28509,-28521,-28534,-28546,-28558,-28571,-28583,-28595,-28608,-28620,-28632,-28644,-28657,-28669,-28681,-28693,-28705,-28717,-28729,-28741,-28754,-28766,-28778,-28790,-28802,-28814,-28826,-28838,-28849,-28861,-28873,-28885,-28897,-28909,-28921,-28932,-28944,-28956,-28968,-28980,-28991,-29003,-29015,-29026,-29038,-29050,-29061,-29073,-29084,-29096,-29108,-29119,-29131,-29142,-29154,-29165,-29177,-29188,-29199,-29211,-29222,-29234,-29245,-29256,-29268,-29279,-29290,-29301,-29313,-29324,-29335,-29346,-29357,-29369,-29380,-29391,-29402,-29413,-29424,-29435,-29446,-29457,-29468,-29479,-29490,-29501,-29512,-29523,-29534,-29545,-29556,-29566,-29577,-29588,-29599,-29610,-29620,-29631,-29642,-29653,-29663,-29674,-29685,-29695,-29706,-29717,-29727,-29738,-29748,-29759,-29769,-29780,-29790,-29801,-29811,-29822,-29832,-29842,-29853,-29863,-29873,-29884,-29894,-29904,-29915,-29925,-29935,-29945,-29956,-29966,-29976,-29986,-29996,-30006,-30016,-30026,-30036,-30047,-30057,-30067,-30077,-30086,-30096,-30106,-30116,-30126,-30136,-30146,-30156,-30166,-30175,-30185,-30195,-30205,-30214,-30224,-30234,-30244,-30253,-30263,-30273,-30282,-30292,-30301,-30311,-30320,-30330,-30339,-30349,-30358,-30368,-30377,-30387,-30396,-30405,-30415,-30424,-30434,-30443,-30452,-30461,-30471,-30480,-30489,-30498,-30507,-30517,-30526,-30535,-30544,-30553,-30562,-30571,-30580,-30589,-30598,-30607,-30616,-30625,-30634,-30643,-30652,-30661,-30670,-30679,-30687,-30696,-30705,-30714,-30723,-30731,-30740,-30749,-30757,-30766,-30775,-30783,-30792,-30800,-30809,-30818,-30826,-30835,-30843,-30852,-30860,-30869,-30877,-30885,-30894,-30902,-30910,-30919,-30927,-30935,-30944,-30952,-30960,-30968,-30977,-30985,-30993,-31001,-31009,-31017,-31025,-31034,-31042,-31050,-31058,-31066,-31074,-31082,-31090,-31098,-31105,-31113,-31121,-31129,-31137,-31145,-31153,-31160,-31168,-31176,-31184,-31191,-31199,-31207,-31214,-31222,-31230,-31237,-31245,-31252,-31260,-31267,-31275,-31282,-31290,-31297,-31305,-31312,-31320,-31327,-31334,-31342,-31349,-31356,-31364,-31371,-31378,-31385,-31393,-31400,-31407,-31414,-31421,-31428,-31436,-31443,-31450,-31457,-31464,-31471,-31478,-31485,-31492,-31499,-31506,-31512,-31519,-31526,-31533,-31540,-31547,-31553,-31560,-31567,-31574,-31580,-31587,-31594,-31600,-31607,-31614,-31620,-31627,-31634,-31640,-31647,-31653,-31660,-31666,-31673,-31679,-31685,-31692,-31698,-31705,-31711,-31717,-31723,-31730,-31736,-31742,-31749,-31755,-31761,-31767,-31773,-31779,-31786,-31792,-31798,-31804,-31810,-31816,-31822,-31828,-31834,-31840,-31846,-31852,-31857,-31863,-31869,-31875,-31881,-31887,-31892,-31898,-31904,-31910,-31915,-31921,-31927,-31932,-31938,-31944,-31949,-31955,-31960,-31966,-31971,-31977,-31982,-31988,-31993,-31999,-32004,-32010,-32015,-32020,-32026,-32031,-32036,-32041,-32047,-32052,-32057,-32062,-32068,-32073,-32078,-32083,-32088,-32093,-32098,-32103,-32108,-32113,-32118,-32123,-32128,-32133,-32138,-32143,-32148,-32153,-32158,-32162,-32167,-32172,-32177,-32181,-32186,-32191,-32196,-32200,-32205,-32210,-32214,-32219,-32223,-32228,-32232,-32237,-32241,-32246,-32250,-32255,-32259,-32264,-32268,-32272,-32277,-32281,-32285,-32290,-32294,-32298,-32302,-32307,-32311,-32315,-32319,-32323,-32327,-32331,-32336,-32340,-32344,-32348,-32352,-32356,-32360,-32364,-32368,-32371,-32375,-32379,-32383,-32387,-32391,-32394,-32398,-32402,-32406,-32409,-32413,-32417,-32421,-32424,-32428,-32431,-32435,-32439,-32442,-32446,-32449,-32453,-32456,-32460,-32463,-32466,-32470,-32473,-32476,-32480,-32483,-32486,-32490,-32493,-32496,-32499,-32503,-32506,-32509,-32512,-32515,-32518,-32521,-32525,-32528,-32531,-32534,-32537,-32540,-32543,-32545,-32548,-32551,-32554,-32557,-32560,-32563,-32565,-32568,-32571,-32574,-32576,-32579,-32582,-32585,-32587,-32590,-32592,-32595,-32598,-32600,-32603,-32605,-32608,-32610,-32613,-32615,-32617,-32620,-32622,-32625,-32627,-32629,-32632,-32634,-32636,-32638,-32641,-32643,-32645,-32647,-32649,-32651,-32654,-32656,-32658,-32660,-32662,-32664,-32666,-32668,-32670,-32672,-32674,-32675,-32677,-32679,-32681,-32683,-32685,-32686,-32688,-32690,-32692,-32693,-32695,-32697,-32698,-32700,-32702,-32703,-32705,-32706,-32708,-32709,-32711,-32712,-32714,-32715,-32717,-32718,-32719,-32721,-32722,-32723,-32725,-32726,-32727,-32729,-32730,-32731,-32732,-32733,-32734,-32736,-32737,-32738,-32739,-32740,-32741,-32742,-32743,-32744,-32745,-32746,-32747,-32748,-32748,-32749,-32750,-32751,-32752,-32753,-32753,-32754,-32755,-32756,-32756,-32757,-32757,-32758,-32759,-32759,-32760,-32760,-32761,-32761,-32762,-32762,-32763,-32763,-32764,-32764,-32765,-32765,-32765,-32766,-32766,-32766,-32766,-32767,-32767,-32767,-32767,-32767,-32768,-32768,-32768,-32768,-32768,-32768,-32768,-32768};

float phase = 0;
float frq_curr = 0;
int16_t outlevel = 0;
        
inline void delay10()
{
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
    Nop();
}


void base_tick(void)
{
    float step_phase;
    float lookup_phase;
    
    y++;
    
    if (state == STATE_LOG)
    {
        if (bufptr >= buffMax)
        {
            state = STATE_SEND;
            bufptr = 0;
        }
        else
        {
            //TODO Add switch for writing buffer
            buffer[0][bufptr] = ADCBUF0;
            bufptr++;
            buffer[0][bufptr] = ADCBUF1;
            bufptr++;
            buffer[0][bufptr] = ADCBUF9;
            bufptr++;
            buffer[0][bufptr] = outlevel;
            bufptr++;
        }
    }
    if ((state == STATE_GL) | (state == STATE_GEN))
    {
        step_phase = frq_curr /(float)PWM_FREQ;
        step_phase = step_phase * 2.0 * (float)SINROM_SIZE;
        phase = phase + step_phase;
        if (phase >= ((float)SINROM_SIZE * 2.0))
        {
            phase = phase - (float)SINROM_SIZE;
        }
        if (phase >= (float)SINROM_SIZE)
        {
            lookup_phase = (float)SINROM_SIZE - (phase - (float)SINROM_SIZE);
        }
        else
        {
            lookup_phase = phase;
        }
        outlevel = floor(lookup_phase);
    }
    else
    {
        phase = 0.0;
    }

    ana_read[0] = ADCBUF0;
    ana_read[1] = ADCBUF1;
    ana_read[2] = ADCBUF9;
    ADC1_SoftwareTriggerEnable();
    return;
}

int main(void)
{
    // initialize the device 
    SYSTEM_Initialize();

    ADC1_SoftwareTriggerEnable();
    
    PWM_SetGenerator1InterruptHandler(base_tick);
    //sp0_SetInterruptHandler(base_tick);
    
    TMR1_Start();
    
    while (1)
    {
        x++;
        
        if (UART1_IsRxReady())
        {
            uart1 = UART1_Read();
            if (uart1 == 'X')
            {
                bufptr = 0;
                state = STATE_LOG;
            }
            if (uart1 == 'Y')
            {
                bufptr = 0;
                state = STATE_TEST;
            }
        }
        
        if (state == STATE_SEND)
        {
            if (bufptr == 0)
            {
                printf("\033[2J");
                while (!U1STAHbits.UTXBE)
                {

                }
            }
            
            printf("%u",buffer[0][bufptr]);
            while (!U1STAHbits.UTXBE)
            {

            }
            printf(",%u",bufptr);
            while (!U1STAHbits.UTXBE)
            {

            }
            printf("\r\n");
            while (!U1STAHbits.UTXBE)
            {

            }
            bufptr++;
            if (bufptr >= buffMax)
            {
                state = STATE_IDLE;
                bufptr = 0;
            }
        }
        if (state = STATE_TEST)
        {
            
        }
    }
    return 1; 
}
/**1
 End of File
*/

